<inject from="/component/card-package" name="card-package"></inject>
<div>
    <p>Search Package</p>
    <p>Find me packages between</p>
    <form submit.trigger="search(this)">
        <p>
            <input type="date" name="startDate" class="form-control" value.bind="_startDate == '' ? dates.toYYYYMMDD(new Date()) : _startDate">
            and
            <input type="date" name="endDate" class="form-control" value.bind="_endDate == '' ? dates.toYYYYMMDD(new Date((new Date()).getTime() + 31536000000)) : _endDate">
        </p>
        <p>
            <input type="submit" value="Search" class="btn btn-default">
        </p>
    </form>
    <div data.load="queryPackages()">
        <div class="row">
            <div class="col-md-4 col-sm-6" for.each="pkg in data" >
                <card-package click.trigger="generateLink(pkg.id)" pkg.bind="pkg"></card-package>
            </div>
        </div>
        <!--
        <ul>
            <li for.each="pkg in data" >
                <a href.bind="generateLink(pkg.id)">{{pkg.packageName}}  ({{dates.rangePrettifier((new Date(pkg.travelDateFrom)), (new Date(pkg.travelDateUntil)))}}) (LA: {{numbers.money(pkg.costLandArrangements)}}; Tickets: {{numbers.money(pkg.costTickets)}})</a>
            </li>
        </ul>
        -->
    </div>
</div>

<script>
    var dates = $inject('/common/dates');
    var errorMessage = '';
    var _startDate = '';
    var _endDate = '';

    function generateLink(id){
        window.location.hash = '#app/action.showPackage:packageId='+id;
    }

    function queryPackages(){
        return new Promise(function(resolve){
            //var form = formGlobal;

            if(_startDate == "" || _endDate == "") resolve([]);
            var startDate = new Date(_startDate + " 00:00:00");
            var endDate = new Date(_endDate + " 23:59:59");
            var query = {};
            query.isPublished = "true";
            query.validUntil = {"$gte": (new Date()).getTime()};
            query.$and = [
                {travelDateFrom: {"$gte": startDate.getTime()}},
                {travelDateFrom: {"$lte": endDate.getTime()}}
            ];
            query.$sort={"travelDateFrom":1};
            dpd.packages.get(query, function(pkg, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                }else {
                    resolve(pkg);
                }
            });
        });

    }

    function search(form){
        //formGlobal = form;
        _startDate = form.elements.startDate.value;
        _endDate = form.elements.endDate.value;
        $patchChanges();
        return false;
    }
</script>

