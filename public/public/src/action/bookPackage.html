<inject from="/component/card-booking" name="card-booking"></inject>

<div>
	<div if.bind="errorMessage != ''">
	    {{errorMessage}}
	</div>

	<div data.load="queryBooking($bookingId)">
		<card-booking bkg.bind="data"></card-booking>
	</div>
	<form submit.trigger="registerPassenger(this)" >
		<input type="hidden" name="bookingId" value.bind="$bookingId">
		<p>First Name: <input type="text" name="firstName"></p>
		<p>Middle Name: <input type="text" name="middleName"></p>
		<p>Last Name: <input type="text" name="lastName"></p>
		<p>Birth Place: <input type="text" name="birthPlace"></p>
		<p>Birthday: <input type="date" name="birthday"></p>
		<p>Passport No: <input type="text" name="passportNumber"></p>
		<p>Passport Expiry Date: <input type="date" name="passportExpiryDate"></p>
		<p><input type="submit" value="Add Passenger" class="btn btn-default"></p>
	</form>
	<p><input type="button" value="Done and Go to Payment Detail" click.trigger="calculatePaymentDetail()" class="btn btn-default"></p>
</div>

<div data.load="getPassengers($bookingId)">
	<p for.each="psg in data">
		First Name: {{psg.firstName}}; Middle Name: {{psg.middleName}}; Last Name: {{psg.lastName}};
		Birth Place: {{psg.birthPlace}}; Birth Date: {{dates.formatter(psg.birthday)}}
		Passport No: {{psg.passportNumber}}; Expiry Date: {{dates.formatter(psg.passportExpiryDate)}}
	</p>
</div>

<script>

    var package = {};
    var booking = {};

    //var numOfPassenger = 0;
    var errorMessage = '';

    function setPackage(pkg) {
    	package = pkg;
    }

    function getPackage() {
    	return package;
    }

    function setBooking(bkg) {
    	var nop = booking.numberOfPassengers?booking.numberOfPassengers:0;
    	booking = bkg; 
    	booking.numberOfPassengers = nop;
    }

    function setNumberOfPassengers(numBeRofpassengers) {
    	booking.numberOfPassengers = numBeRofpassengers
    }
    function getBooking() {
    	return booking;
    }

    function calculatePaymentDetail(userId, packageId) {
        window.location.hash = '#app/action.paymentDetails:bookingId=' + booking.id;
    }

    function getPassengers(bookingId) {
    	//debugger;
    	return new Promise(function(resolve) {
	    	dpd.passengers.get({"bookingId":bookingId}, function(passengers, err)
	    	{
                if(err){
                    errorMessage = JSON.stringify(err);
                }else {
                	//numOfPassenger = passengers.length;
                	//booking.numBeRofpassengers = passengers.length;
                	setNumberOfPassengers(passengers.length);
                    resolve(passengers);
                }
	    	});
	    });
    }

    function registerPassenger(form){
    	booking.uniqueCode = Math.floor(Math.random() * 1000);
    	booking.totalPrice = booking.numberOfPassengers * (booking.costTickets + booking.costLandArrangements);
        dpd.bookings.put(booking, function(booking, err) {
            if(err){
                errorMessage = JSON.stringify(err);
                $patchChanges();
            } else {
            }
        });

    	var q = {};
    	q.bookingId = form.elements.bookingId.value;
        q.firstName = form.elements.firstName.value;
        q.middleName = form.elements.middleName.value;
        q.lastName = form.elements.lastName.value;
        q.birthPlace = form.elements.birthPlace.value;
        q.birthday = (new Date(form.elements.birthday.value)).getTime();
        q.passportNumber = form.elements.passportNumber.value;
        q.passportExpiryDate = (new Date(form.elements.passportExpiryDate.value)).getTime();

    	form.elements.bookingId.value = "";
        form.elements.firstName.value = "";
        form.elements.middleName.value = "";
        form.elements.lastName.value = "";
        form.elements.birthPlace.value = "";
        form.elements.birthday.value = "";
        form.elements.passportNumber.value = "";
        form.elements.passportExpiryDate.value = "";

        dpd.passengers.post(q, function(user, err) {
            if(err){
                errorMessage = JSON.stringify(err);
            }
            $patchChanges();
        });


	    return false;
    }

    function queryTravelAgent(id) {
        return new Promise(function(resolve){
            dpd.travelagents.get(id, function(agent, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                }else {
                	;
                    resolve(agent);
                }
            });
        });
    }

    function queryPackage(id){
    	
        return new Promise(function(resolve){
            dpd.packages.get(id, function(pkg, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                }else {
                    queryTravelAgent(pkg.travelAgentId).then(function(agent){
                        pkg.agent = agent;
                        resolve(pkg);
                    });
                }
            });
        });
    }

    function queryBooking(id){
    	return new Promise(function(resolve){
    		dpd.bookings.get(id, function(bkg, err) {
    			if(err) {
    				errorMessage = JSON.stringify(err);
    			} else {
    				setBooking(bkg);
    				queryPackage(bkg.packageId).then(function(pkg){
    					setPackage(pkg);
    					bkg.package = pkg;
    					//debugger;
                        resolve(bkg);
    				});
    			}
    		});
    	});
    }
</script>