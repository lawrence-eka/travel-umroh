<inject from="/component/card-package" name="card-package"></inject>
<inject from="/component/card-itinerary" name="itrLines"></inject>

<div if.bind="errorMessage != ''">
    {{errorMessage}}
</div>

<input type="button" value="Book This!" click.trigger="book($packageId)" class="btn btn-default"></input>
<div data.load="queryPackage($packageId)">
    <card-package pkg.bind="data"></card-package>
</div>

<div data.load="queryItineraries($packageId)">
    <p for.each="itr in data">
        <itrLines itr.bind="itr"></itrLines>
    </p>
</div>
<input type="button" value="Book This!" click.trigger="book($packageId)" class="btn btn-default"></input>

<script>
    var errorMessage ="";
    var dates = $inject('/common/dates');
    var numbers = $inject('/common/numbers');

    function book(packageId){
        dpd.users.me(function(me) {
            queryPackage(packageId).then(function(pkg){
                var q = {
                    "userId": me.id,
                    "packageId": pkg.id,
                    "costTickets": pkg.costTickets,
                    "costLandArrangements": pkg.costLandArrangements
                };
                dpd.bookings.post(q, function(booking, err) {
                    if(err){
                        errorMessage = JSON.stringify(err);
                        $patchChanges();
                    } else {
                        var bookingId = (booking.message ? JSON.parse(booking.message).booking.id : booking.id);
                        window.location.hash = '#app/action.bookPackage:bookingId=' + bookingId;
                    }
                });
            });
        });
    }


    function queryPackage(id){
        return new Promise(function(resolve){
            dpd.packages.get(id, function(pkg, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                }else {
                    queryTravelAgent(pkg.travelAgentId).then(function(agent){
                        pkg.agent = agent;
                        resolve(pkg);
                    });
                }
            });
        });
    }

    function queryTravelAgent(id) {
        return new Promise(function(resolve){
            dpd.travelagents.get(id, function(agent, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                }else {
                    resolve(agent);
                }
            });
        });
    }

    function queryItineraries(packageId){
        return new Promise(function(resolve){
            var q = {
                packageId: packageId,
                $sort:{"fromDateTime":1}
            }
            dpd.itineraries.get(q, function(itineraries, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                }else {
                    resolve(itineraries);
                }
            });
        });
    }

</script>