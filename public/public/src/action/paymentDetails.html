<style src
<inject from="/component/card-booking" name="card-booking"></inject>
<inject from="/component/card" name="card"></inject>

Payment Detail
<div if.bind="errorMessage">
    {{errorMessage}}
</div>
<div data.load="getPaymentDetails($bookingId)">
    <card-booking bkg.bind="data"></card-booking>
    <card title="Payment Info" remarks="Please make the payment Within the next 3 hours to avoid automatic cancellation of your booking">
        <div>
            Total: {{numbers.money(booking.totalPrice + booking.uniqueCode)}}<br/>
            Bank: Bank Central Asia<br/>
            Branch: Sidoarjo<br/>
            Account No:1234567890<br/>
            Name: PT Pete Tbk.<br/>
        </div>
    </card>
    <form submit.trigger="paymentConfirmation(this)">
    	<p>Put your payment confirmation here:</p>
        <p>Bank: <input type="text" name="fromBank"></p>
        <p>Branch: <input type="text" name="fromBranch"></p>
        <p>Account Number: <input type="text" name="fromAccountNumber"></p>
        <p>Account Holder: <input type="text" name="fromAccountHolder"></p>
        <p>Payment: <input type="number" name="actualPayment"></p>
        <p>Payment Time: <input type="datetime-local" name="paymentDate"></p>
	    <p><input type="submit" value="Payment Confirmation"  class="btn btn-default"/></p>
    </form>
</div>

<script>
	var errorMessage="";

    var package = {};
    var booking = {};

    function setPackage(pkg) {
    	package = pkg;
    }

    function getPackage() {
    	return package;
    }

    function setBooking(bkg) {
    	booking = bkg; 
    }

    function getBooking() {
    	return booking;
    }

    function paymentConfirmation(form) {
    	booking.fromBank = form.elements.fromBank.value;
    	booking.fromBranch = form.elements.fromBranch.value;
    	booking.fromAccountNumber  = form.elements.fromAccountNumber.value;
    	booking.fromAccountHolder = form.elements.fromAccountHolder.value;
    	booking.actualPayment = form.elements.actualPayment.value;
    	booking.paymentDate = (new Date(form.elements.paymentDate.value)).getTime();
		doPaymentConfirmation();
        return false;
    }

    function doPaymentConfirmation() {
        return new Promise(function(resolve){
	        dpd.bookings.put(booking, function(bkg, err) {
	            if(err){
	                errorMessage = JSON.stringify(err);
	                $patchChanges();
	            } else {
			        window.location.hash = '#app/action.paymentConfirmation:bookingId=' + booking.id;
	            }
	        });
        });
    }

    function queryTravelAgent(id) {
        return new Promise(function(resolve){
            dpd.travelagents.get(id, function(agent, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                }else {
                    resolve(agent);
                }
            });
        });
    }

    function queryPackage(id){
    	
        return new Promise(function(resolve){
            dpd.packages.get(id, function(pkg, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                }else {
                    queryTravelAgent(pkg.travelAgentId).then(function(agent){
                        pkg.agent = agent;
                        resolve(pkg);
                    });
                }
            });
        });
    }

	function getPaymentDetails(bookingId) {
        return new Promise(function(resolve) {
            dpd.bookings.get(bookingId, function(bkg, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                } else {
                	setBooking(bkg);
    				queryPackage(bkg.packageId).then(function(pkg){
    					setPackage(pkg);
    					bkg.package = pkg;
    					//debugger;
                        resolve(bkg);
    				});
                }
            });

        });
    }
</script>