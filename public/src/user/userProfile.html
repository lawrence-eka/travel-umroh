<link href="asset/css/custom-style.css" rel="stylesheet">
<inject from="/component/alert" name="alert"></inject>
<inject from="/component/entry" name="entry"></inject>
<inject from="/component/panel" name="panel"></inject>
<inject from="/component/ppLink" name="ppLink"></inject>

<div >
    <panel title.bind="whatTitle($profile)">
        <div slot.name="footer">
            <ppLink></ppLink>
        </div>
        <div slot.name="body" data.load="loadProfile($profile)">
            <span ref.name="alert">
                <form>
                    <div class="row">
                        <input type="hidden" name="id" value.bind="data.id">
                        <entry type="text" prompt="First Name" name="firstName" value.bind="data.firstName"></entry>
                        <entry type="text" prompt="Last Name" name="lastName" value.bind="data.lastName"></entry>

                        <entry type="hidden" prompt="username" name="username" value.bind="data.username"></entry>
                        <entry type="email" prompt="Email" name="email" value.bind="data.email" alias="username" alert.bind="@alert"></entry>
                        <entry type="text" prompt="Phone" name="phone" value.bind="data.phone"></entry>

                        <entry type="textarea" prompt="Address" name="address1" value.bind="data.address1"></entry>

                        <entry type="text" prompt="City" name="city" value.bind="data.city"></entry>

                        <entry type="checkbox" prompt="Travel Agent" name="isTravelAgent" checked.bind="data.isTravelAgent"></entry>
                        <entry type="checkbox" prompt="Administrator" name="isAdmin" checked.bind="data.isAdmin"></entry>

                        <entry type="password" prompt="Password" name="password" value.bind="data.password" alert.bind="@alert"></entry>
                        <entry type="password" prompt="Repeat Password" name="repeatPassword" alert.bind="@alert"></entry>

                        <entry type="button" name="btnSave" value.bind="$profile ? 'Save' : 'Register'" divClass="col-xs-6 col-sm-6 col-md-6 col-lg-6" click.trigger="onRegister()"></entry>
                        <entry type="button" name="btnCancel" value="Cancel" divClass="col-xs-6 col-sm-6 col-md-6 col-lg-6" click.trigger="onCancel()"></entry>
                    </div>
                </form>
                <alert alertType.bind="@alert.type()" message.bind="@alert.text()"></alert>
            </span>
        </div>
    </panel>
</div>

<script>

    function initState(props) {
        var state = {
        	alert: new Alert(null, $patchChanges, "alert"),
            originalProfile: null,
        };
        state.alert.alert(props.error);
        return state;
    }

    function onPropertyChange(event) {
    	debugger;
        if(event.error) this.state.alert.alert(event.error.newValue);
    }

    function loadProfile(profile){
    	this.state.originalProfile = (profile? profile : {});
        return this.state.originalProfile;
    }

    function whatTitle(profile) {
    	if(!profile) return "Please Sign Up";
    	else if(profile.id == storage.me.read().id) return "Your Profile";
    	else return "User Profile";
    }
    function onRegister(){
        this.state.alert.alert('');
        var form = this.target.form;

        if(form.elements.password.value != form.elements.repeatPassword.value ) {
            this.state.alert.alert({name: "repeatPassword", message: "Please repeat your password correctly"});
            return;
        }

        var profile = {};
        profile.id = form.elements.id.value;
        profile.firstName = form.elements.firstName.value;

        profile.lastName = form.elements.lastName.value;
        profile.email = form.elements.email.value;
        profile.phone = form.elements.phone.value;
        profile.username = form.elements.email.value;

        if(profile.username) profile.username = profile.username.toLowerCase();
        if(form.elements.password.value != '') profile.password = form.elements.password.value;

        profile.address1 = form.elements.address1.value;
        profile.city = form.elements.city.value;

        if(this.state.originalProfile.isAdmin != form.elements.isAdmin.checked) profile.isAdmin = (form.elements.isAdmin.checked);
	    if(this.state.originalProfile.isTravelAgent != form.elements.isTravelAgent.checked) profile.isTravelAgent = (form.elements.isTravelAgent.checked);

        //debugger;
        this.emitEvent('save', profile);
    }

    function onCancel() {
        this.emitEvent('cancel');
    }

</script>

