<inject from="/component/userProfile" name="profile"></inject>

<div class="container small-margin-top">
    <profile error.bind="@error.message" save.trigger="register(event)" cancel.trigger="cancelRegistration()" errorMessage.bind="@error.message"></profile>
</div>

<script>
    function initState() {
        return {
            error : {
                message : ''
            }
        };
    }

    function cancelRegistration() {
        window.location.hash = "#app";
    }

    function register(profile){
        profile = profile.data;
        var self = this;
        dpd.users.post(profile, function(user, err) {
            if(err){
                self.state.error.message = err;
                $patchChanges();
            }else{
                dpd.users.login({"username": profile.username, "password": profile.password}, function(user, err) {
                    if(err){
                        self.state.error.message = err;
                        $patchChanges();
                    }else{
                        window.location.hash = '#app';
                    }
                });
            }

        });
    }
</script>

