<inject from="/user/userProfile" name="profile"></inject>

<div class="container small-margin-top">
    <profile save.trigger="register(event)" cancel.trigger="cancelRegistration()" error.bind="@error"></profile>
</div>

<script>
    function initState() {
        return {
        	error: null,
        }
    }

    function onPropertyChange(props) {
    	if(props.error) {this.state.error = props.error.newValue;}
    }
    function cancelRegistration() {
        window.location.hash = "#app";
    }

    function register(profile){
    	//debugger;
        profile = profile.data;
        var self = this;
        dpd.users.post(profile, function(user, err) {
        	//debugger;
        	if(err) {
		        self.state.error = err;
		        $patchChanges();
	        } else {
                dpd.users.login({"username": profile.username, "password": profile.password}, function(user, err) {
                	//ebugger;
                	if(err) {
		                self.state.alert.alert(err);
		                $patchChanges();
	                } else {
                		profile.password=undefined;
                		storage.me.save(profile);
                        window.location.hash = '#app';
                    }
                });
            }

        });
    }
</script>

