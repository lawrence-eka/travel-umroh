<inject from="/booking/card-booking" name="card-booking"></inject>
<inject from="/booking/card-passenger" name="card-passenger"></inject>
<inject from="/booking/edit-passenger" name="edit-passenger"></inject>
<inject from="/component/alert" name="alert"></inject>
<inject from="/component/entry" name="entry"></inject>
<inject from="/component/panel" name="panel"></inject>
<inject from="/component/ppLink" name="ppLink"></inject>
<link href="asset/css/custom-style.css" rel="stylesheet">

<div data.load="queryBooking(@bookingId)">
	<div>
		<card-booking bkg.bind="data" ></card-booking>
	</div>
	<edit-passenger booking.bind="data"></edit-passenger>
	<div data.load="getPassengers(@bookingId)">
		<p for.each="psg in data">
			<card-passenger passenger.bind="psg"></card-passenger>
		</p>
	</div>
</div>


<script>
	function initState(props) {
		return {
			bookingId: props.bookingId,
		}
	}
    var package = {};
    var booking = {};

    //var numOfPassenger = 0;
    var errorMessage = '';

    function setPackage(pkg) {
    	package = pkg;
    }

    function getPackage() {
    	return package;
    }

    function setBooking(bkg) {
    	var nop = booking.numberOfPassengers?booking.numberOfPassengers:0;
    	booking = bkg;
    	booking.numberOfPassengers = nop;
    }

    function setNumberOfPassengers(numberOfPassengers) {
    	booking.numberOfPassengers = numberOfPassengers
    }
    function getBooking() {
    	return booking;
    }

    function getPassengers(bookingId) {
    	debugger;
    	return new Promise(function(resolve) {
	    	dpd.passengers.get({"bookingId":bookingId}, function(passengers, err)
	    	{
                if(err){
                    errorMessage = JSON.stringify(err);
                }else {
                	setNumberOfPassengers(passengers.length);
                    resolve(passengers);
                }
	    	});
	    });
    }

    function queryBooking(id){
    	return new Promise(function(resolve){
    		dpd.bookings.get(id, function(bkg, err) {
    			if(err) {
    				errorMessage = JSON.stringify(err);
    			} else {
    			    resolve(bkg);
    				setBooking(bkg);
    			}
    		});
    	});
    }
</script>