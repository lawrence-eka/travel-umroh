<inject from="/component/panel" name="panel"></inject>
<inject from="/component/entry" name="entry"></inject>
<inject from="/component/alert" name="alert"></inject>
<inject from="/package/card-package" name="card-package"></inject>
<link href="asset/css/custom-style.css" rel="stylesheet">

<div>
    <div ref.name="panelParam">
        <panel title="Search Packages" footer.bind="@recordsFound">
            <div slot.name="body">
                <form>
                    <entry type="date" prompt="Between" name="startDate" value.bind="@datePair.defaultStartDate()" min.bind="@datePair.minStartDate()" focusout.trigger="@datePair.onStartDateFocusOut('endDate')"></entry>
                    <span ref.name="endDate">
                        <entry type="date" prompt="And" name="endDate" value.bind="@datePair.defaultEndDate()" min.bind="@datePair.minEndDate()"></entry>
                    </span>
                    <entry type="button" value="Search" click.trigger="search()"></entry>
                </form>
            </div>
        </panel>
    </div>
    <alert alertType.bind="@alert.type()" message.bind="@alert.text()"></alert>
    <div data.load="queryPackages()">
        <div for.each="pkg in data" >
            <card-package click.trigger="generateLink(event)" pkg.bind="pkg"></card-package>
        </div>
    </div>
</div>

<script>
    function initState(props) {
    	//debugger;
        var state = {
	        recordsFound: '',
	        alert:new Alert(),
	        datePair: new DatePair($patchChanges, null, '1y'),
            date: {},
        };
	    state.date.start = new Date(state.datePair.defaultStartDate());
	    state.date.end = new Date(state.datePair.defaultEndDate());

    	return state;
    }

    function onPropertyChange(event) {
    	//debugger;
    }
    function generateLink(event){
        window.location.hash = '#app/booking.showPackage:packageId='+event.data;
    }

    function queryPackages(){
    	//debugger;
        var self = this;
        return new Promise(function(resolve){
            if(self.state.date.start == "" || self.state.date.end == "") resolve([]);
            var startDate = (new Date(self.state.date.start)).setHours(0,0,0,0);
            var endDate = (new Date(self.state.date.end)).setHours(23,59,59,999);
            var query = {};
            query.isPublished = "true";
	        //query.validFrom = {"$lte": (new Date()).getTime()};
	        query.validUntil = {"$gte": (new Date()).getTime()};
            query.$and = [
                {travelDateFrom: {"$gte": startDate}},
                {travelDateFrom: {"$lte": endDate}}
            ];
            query.$sort={"travelDateFrom":1};
            dpd.packages.get(query, function(pkg, err) {
            	debugger;
                if(err){
                    self.state.alert.alert(err);
                    self.state.recordsFound = "";
                }else {
                    self.state.alert.alert('');
                	self.state.recordsFound = (pkg.length > 0 ? pkg.length.toString() + ' package' +(pkg.length == 1 ? '' : 's') : 'No package') + ' found';
                	$patchChanges("panelParam");
                }
	            resolve(pkg);
            });
        });

    }

    function search(){
    	var form = this.target.form;
        this.state.date.start = form.elements.startDate.value;
        this.state.date.end = form.elements.endDate.value;
        $patchChanges();
    }
</script>

