<inject from="/component/alert" name="alert"></inject>
<inject from="/component/entry" name="entry"></inject>
<inject from="/component/panel" name="panel"></inject>
<inject from="/component/ppLink" name="ppLink"></inject>

<div>
    <panel title="Passenger Detail">
        <div slot.name="body">
            <form role="form">
                <div slot.name="footer">
                    <ppLink></ppLink>
                </div>
                <div class="row">
                    <entry type="hidden" name="bookingId" value.bind="@bookingId"></entry>
                    <entry type="text" prompt="First Name" name="firstName"></entry>
                    <entry type="text" prompt="Middle Name" name="middleName"></entry>
                    <entry type="text" prompt="Last Name" name="lastName"></entry>
                    <entry type="text" prompt="Birth Place" name="birthPlace"></entry>
                    <entry type="date" prompt="Birthday" name="birthday" value.bind = "(new Date()).toYYYYMMDD()" max.bind="(new Date()).toYYYYMMDD()"></entry>
                    <entry type="text" prompt="Passport Number" name="passportNumber"></entry>
                    <entry type="date" prompt="Passport Issue Date" name="passportIssueDate" value.bind = "(new Date()).toYYYYMMDD()" max.bind="(new Date()).toYYYYMMDD()"></entry>
                    <entry type="date" prompt="Passport Expiry Date" name="passportExpiryDate" value.bind = "(new Date()).toYYYYMMDD()" min.bind="(new Date()).toYYYYMMDD()"></entry>
                    <entry type="text" prompt="Passport Issuer" name="passportIssuer"></entry>
                    <entry type="button" name="btnRegister" value="Register" click.trigger="registerPassenger()"></entry>
                    <entry type="button" name="btnPaymentDetail" value="Payment Detail" click.trigger="calculatePaymentDetail()"></entry>
                </div>
            </form>
        </div>
    </panel>
    <span ref.name="alert">
        <alert alertType.bind="@alert.type()" message.bind="@alert.text()"></alert>
    </span>
</div>
<script>
    function initState(props) {
    	debugger;
    	return {
    		booking: props.booking,
    		bookingId: props.booking.id,
            alert: new Alert(null, $patchChanges, "alert"),
        }
    }

    function registerPassenger(){
    	debugger;
	    //booking.uniqueCode = Math.floor(Math.random() * 1000);
        var self = this;
	    self.state.booking.totalPrice = self.state.booking.numberOfPassengers * (self.state.booking.costTickets + self.state.booking.costLandArrangements);
	    dpd.bookings.put(self.state.booking, function(booking, err) {
		    self.state.alert.alert(err);
		    if(!err){
			    var form = self.target.form;

			    var q = {};
			    q.bookingId = form.elements.bookingId.value;
			    q.firstName = form.elements.firstName.value;
			    q.middleName = form.elements.middleName.value;
			    q.lastName = form.elements.lastName.value;
			    q.birthPlace = form.elements.birthPlace.value;
			    q.birthday = (new Date(form.elements.birthday.value)).getTime();
			    q.passportNumber = form.elements.passportNumber.value;
			    q.passportIssuer = form.elements.passportIssuer.value;
			    q.passportIssueDate = (new Date(form.elements.passportIssueDate.value)).getTime();
			    q.passportExpiryDate = (new Date(form.elements.passportExpiryDate.value)).getTime();

			    form.elements.firstName.value = "";
			    form.elements.middleName.value = "";
			    form.elements.lastName.value = "";
			    form.elements.birthPlace.value = "";
			    form.elements.birthday.value = "";
			    form.elements.passportNumber.value = "";
			    form.elements.passportIssuer.value = "";
			    form.elements.passportIssueDate.value = "";
			    form.elements.passportExpiryDate.value = "";
			    debugger;
			    dpd.passengers.post(q, function(user, err) {
				    debugger;
				    self.state.alert.alert(err);
			    });
		    }
	    });
    }

    function calculatePaymentDetail(bookingId) {
	    booking.uniqueCode = Math.floor(Math.random() * 1000);
	    booking.waitingForPaymentUntil = (new Date()).getTime() + 10800000;
	    dpd.bookings.put(booking, function(bkg, err) {
		    self.state.alert.alert(err);
		    if(!err){
			    window.location.hash = '#app/booking.paymentDetails:bookingId=' + bookingId;
		    }
	    });
    }

</script>