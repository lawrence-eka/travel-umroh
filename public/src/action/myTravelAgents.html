<inject from="/component/card-travel-agent" name="card-travel-agent"></inject>
<inject from="/component/alert" name="alert"></inject>
<inject from="/component/entry" name="entry"></inject>
<link href="asset/css/custom-style.css" rel="stylesheet">

<div>
    <div class="container all-5px" data.load="getOneTravelAgent($travelAgentId)">
        <div class="row centered-form no-top-margin">
            <div class="form-panel col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="panel panel-default custom-panel">
                    <div class="panel-heading">
                        <h3 if.bind="!$travelAgentId" class="panel-title">New Travel Agent</h3>
                        <h3 if.bind="$travelAgentId" class="panel-title">Edit Travel Agent</h3>
                    </div>
                    <div class="panel-body">
                        <alert alertType="error" message.bind="$errorMessage"></alert>
                        <form role="form">
                            <div class="row">
                                <entry type="hidden" name="id"  value.bind="data.id"></entry>
                                <entry type="hidden" name="contactPersonId"  value.bind="data.contactPersonId"></entry>
                                <entry type="text" prompt="Name" name="travelAgentName" value.bind="data.travelAgentName"></entry>
                                <entry type="textarea" prompt="Address" name="address" value.bind="data.address"></entry>
                                <entry type="text" prompt="City" name="city" value.bind="data.city"></entry>
                            </div>
                            <div class="row">
                                <entry type="button" name="btnSave" value.bind="($travelAgentId ? 'Save' : 'Register')" divClass="col-xs-6 col-sm-6 col-md-6 col-lg-6" click.trigger="register()"></entry>
                                <entry type="button" if.bind="$travelAgentId" name="btnCancel" value="Cancel" divClass="col-xs-6 col-sm-6 col-md-6 col-lg-6" click.trigger="cancel()"></entry>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div>
        <div class="row">
            <div data.load="getTravelAgents($travelAgentId)">
                <p for.each="ta in data">
                    <card-travel-agent travelAgent.bind="ta" editTA.trigger="onEditTA(event)" showPackages.trigger="onShowPackages(event)"></card-travel-agent>
                </p>
            </div>
        </div>
    </div>
</div>


<script>
    var errorMessage ="";
    function queryTravelAgents(userId, travelAgentId) {
         return new Promise(function(resolve) {

             var q = {
                 "contactPersonId": userId,
                 "id": {"$ne": (travelAgentId ? travelAgentId : "-1")}
             };
            dpd.travelagents.get(q, function (ta, err) {
                if (err) {
                    errorMessage = err.message;
                    $patchChanges();
                } else {
                    resolve(ta);
                }
                ;
            });
        });
    }

    function getTravelAgents(travelAgentId){
        return new Promise(function(resolve) {
            dpd.users.me(function(me) {
                queryTravelAgents(me.id, travelAgentId).then(function(ta) {
                    resolve(ta);
                });
            });
        });
    }

    function onEditTA(event) {
        window.location.hash="#app/action.myTravelAgents:travelAgentId=" + event.data;
    }

    function onShowPackages(event) {
    	debugger;
    	window.location.hash ="#app/action.myPackages:travelAgentId=" + event.data;
    }

    function getOneTravelAgent(id) {
        return new Promise(function (resolve) {
        	if(id) {
		        dpd.travelagents.get(id, function (ta, err) {
			        if (err) {
				        errorMessage = err.message;
				        $patchChanges();
			        } else {
				        resolve(ta);
			        }
		        });
	        }
        	else {
		        dpd.users.me(function(me) {
                    var ta = {
                        "contactPersonId": me.id
                    }
                    resolve(ta);
                });
            }
        });
    }

    function cancel() {
    	debugger;
	    window.location.hash="#app/action.myTravelAgents";
    }

    function register() {
    	debugger;
	    var form = this.target.form;
    	var q = {
    		"travelAgentName": form.elements.travelAgentName.value,
    		"address": form.elements.address.value,
    		"city": form.elements.city.value,
            "contactPersonId": form.elements.contactPersonId.value
        };
    	if(form.elements.id.value == "") {
    		dpd.travelagents.post(q, cleanupAfterSave);
        } else {
		    dpd.travelagents.put(form.elements.id.value, q, cleanupAfterSave);
	    }
    }

    function cleanupAfterSave(result, err) {
	    if(err) errorMessage = err.message;
	    else {
	    	window.location.hash="#app/action.myTravelAgents";
	    }
	    $patchChanges();
    }

</script>