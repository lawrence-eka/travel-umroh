<inject from="/component/card-travel-agent" name="card-travel-agent"></inject>
<inject from="/component/alert" name="alert"></inject>
<inject from="/component/entry" name="entry"></inject>
<inject from="/component/panel" name="panel"></inject>
<link href="asset/css/custom-style.css" rel="stylesheet">

<div data.load="getOneTravelAgent($travelAgentId)">
    <panel title.bind="($travelAgentId ? 'Edit' : 'New') + ' Travel Agent'" nofooter>
        <div slot.name="body">
            <alert alertType="error" message.bind="$errorMessage"></alert>
            <form role="form">
                <div class="row">
                    <entry type="hidden" name="id"  value.bind="data.id"></entry>
                    <entry type="hidden" name="contactPersonId"  value.bind="data.contactPersonId"></entry>
                    <entry type="text" prompt="Name" name="travelAgentName" value.bind="data.travelAgentName"></entry>
                    <entry type="textarea" prompt="Address" name="address" value.bind="data.address"></entry>
                    <entry type="text" prompt="City" name="city" value.bind="data.city"></entry>
                </div>
                <div class="row">
                    <entry type="button" name="btnSave" value.bind="($travelAgentId ? 'Save' : 'Register')" divClass="col-xs-6 col-sm-6 col-md-6 col-lg-6" click.trigger="register()"></entry>
                    <entry type="button" if.bind="$travelAgentId" name="btnCancel" value="Cancel" divClass="col-xs-6 col-sm-6 col-md-6 col-lg-6" click.trigger="cancel()"></entry>
                </div>

            </form>
        </div>
    </panel>
    <div data.load="getTravelAgents($travelAgentId)">
        <p for.each="ta in data">
            <card-travel-agent travelAgent.bind="ta" editTA.trigger="onEditTA(event)" showPackages.trigger="onShowPackages(event)"></card-travel-agent>
        </p>
    </div>
</div>


<script>

    var tempForm = null;

    var errorMessage ="";
    function queryTravelAgents(userId, travelAgentId) {
         return new Promise(function(resolve) {

             var q = {
                 "contactPersonId": userId,
                 "id": {"$ne": (travelAgentId ? travelAgentId : "-1")}
             };
            dpd.travelagents.get(q, function (ta, err) {
                if (err) {
                    errorMessage = err.message;
                    $patchChanges();
                } else {
                    resolve(ta);
                }
                ;
            });
        });
    }

    function getTravelAgents(travelAgentId){
        return new Promise(function(resolve) {
	        var me = storage.me.read();
            queryTravelAgents(me.id, travelAgentId).then(function(ta) {
                resolve(ta);
            });
        });
    }

    function onEditTA(event) {
        window.location.hash="#app/action.myTravelAgents:travelAgentId=" + event.data;
    }

    function onShowPackages(event) {
    	debugger;
    	window.location.hash ="#app/action.myPackages:travelAgentId=" + event.data;
    }

    function getOneTravelAgent(id) {
        return new Promise(function (resolve) {
        	if(id) {
		        dpd.travelagents.get(id, function (ta, err) {
			        if (err) {
				        errorMessage = err.message;
				        $patchChanges();
			        } else {
				        debugger;
				        resolve(ta);
			        }
		        });
	        }
        	else {
        		debugger;
        		var ta = {
        			"contactPersonId": storage.me.read().id
                };
                resolve(ta);
            }
        });
    }

    function cancel() {
    	debugger;
	    window.location.hash="#app/action.myTravelAgents";
    }

    function register() {
    	debugger;
	    var form = this.target.form;
	    tempForm = this.target.form;
    	var q = {
    		"travelAgentName": form.elements.travelAgentName.value,
    		"address": form.elements.address.value,
    		"city": form.elements.city.value,
            "contactPersonId": form.elements.contactPersonId.value
        };
    	if(form.elements.id.value == "") {
    		dpd.travelagents.post(q, cleanupAfterSave);
        } else {
		    dpd.travelagents.put(form.elements.id.value, q, cleanupAfterSave);
	    }
    }

    function cleanupAfterSave(result, err) {
    	debugger;
	    if(err) errorMessage = err.message;
	    else {
		    var form = tempForm;
		    form.elements.id.value = '';
		    form.elements.travelAgentName.value = '';
			form.elements.address.value = '';
			form.elements.city.value = '';
			form.elements.contactPersonId.value = '';

		    errorMessage = '';
		    window.location.hash="#app/action.myTravelAgents";
	    }
	    $patchChanges();
    }

</script>