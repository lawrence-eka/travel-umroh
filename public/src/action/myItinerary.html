<inject from="/component/panel" name="card"></inject>
<inject from="/component/entry" name="entry"></inject>
<inject from="/component/card-itinerary" name="card-itinerary"></inject>
<inject from="/component/edit-itinerary" name="edit-itinerary"></inject>
<inject from="/component/alert" name="alert"></inject>

<div data.load="getPackage()">
    <card title.bind="data.packageName" nofooter>
        <div slot.name="body">
            <entry type="button" value="Add Transport" click.trigger="onAddItinerary()" if.bind="!@editItineraryId"></entry>
            <entry type="button" value="Add Hotel" click.trigger="onAddItinerary()" if.bind="!@editItineraryId"></entry>
        </div>
    </card>
    <alert alertType.bind="@alert.type()" message.bind="@alert.text()"></alert>
    <edit-itinerary if.bind="@editItineraryId == -1" save.trigger="onSaveItinerary(event)" cancel.trigger="onCancelEdit()" defaults.bind="calculateDefaults()"></edit-itinerary>
    <div data.load="queryItineraries()">
        <p for.each="itr in data">
            <card-itinerary if.bind="itr.id != @editItineraryId" itr.bind="itr" edit.trigger="onEdit(event)" delete.trigger="onDelete(event)"></card-itinerary>
            <edit-itinerary if.bind="itr.id == @editItineraryId" itinerary.bind="itr" save.trigger="onSaveItinerary(event)" cancel.trigger="onCancelEdit()" defaults.bind="calculateDefaults()"></edit-itinerary>
        </p>
    </div>
</div>

<script>
    function initState(props) {
        return {
            packageId: props.packageId,
            itinerary: [],
            editItineraryId: null,
            alert : new Alert(),
        }
    }

	function queryItineraries() {
	    var self = this;
		return new Promise(function (resolve) {
			var q = {
				"packageId": self.state.packageId,
                "$sort": {"fromDateTime":1}
            }
            dpd.itineraries.get(q, function (itr, err) {
                if (err) {
                    self.state.alert.alert(err);
                    self.state.itinerary = [];
                } else {
                    self.state.alert.alert(null);
                    self.state.itinerary = itr;
                }
                resolve(self.state.itinerary);
            });
		});
	}

	function getPackage(){
        var self = this;
		return new Promise(function(resolve){
			dpd.packages.get(self.state.packageId, function(result, err){
				resolve(result);
			});
		});
	}

	function onSaveItinerary(itinerary) {
		debugger;
		itinerary = itinerary.data;
        itinerary.packageId = this.state.packageId;
        var self = this;
        if(itinerary.id=="") {
            dpd.itineraries.post(itinerary, function(result, err) {
                debugger;
                if (err) {
                    self.state.alert.alert(err);
                }
                if(result) {
                    self.state.alert.alert(null);
                    self.state.editItineraryId = -1;
                }
	            $patchChanges();
            });
        }
        else {
            debugger;
            dpd.itineraries.put(itinerary.id, itinerary, function(result, err) {
                debugger;
                if(err) {
                    self.state.alert.alert(err);
                }
                else {
                    self.state.alert.alert(null);
                    self.state.editItineraryId = null;
                }
                $patchChanges();
            });
        }
	}

	function calculateDefaults() {
	    var result = {
	        date: {
                default: (new Date())
            },
            entryType:'Transport'
        };
	    if(this.state && this.state.itinerary && this.state.itinerary.length > 0) {
            if (itineraryId != -1) {
                for (var i = 0; i < this.state.itinerary.length; i++) {
                    if (this.state.itinerary[i].id == this.state.editItineraryId) {
                        if (i > 0) {
                            result.date.min = this.state.itinerary[i - 1].toDateTime;
                        }
                        if (i < this.state.itinerary.length - 1) {
                            result.date.max = this.state.itinerary[i + 1].fromDateTime;
                        }
                        return result;
                    }
                }
            }
            else {
                result.date.default = this.state.itinerary[this.state.itinerary.length - 1].toDateTime;
                result.entryType = this.state.itinerary[this.state.itinerary.length - 1].entry.transport ? 'Hotel' : 'Transport';
            }
        }
        return result;
    }

	function onCancelEdit() {
        this.state.editItineraryId=null;
		$patchChanges();
	}

	function onAddItinerary() {
		this.state.editItineraryId=-1;
		$patchChanges();
    }
	function onEdit(itineraryId) {
        this.state.editItineraryId = itineraryId.data;
		$patchChanges();
    }

    function onDelete(itineraryId) {
		//debugger;
        var self = this;
        dpd.itineraries.del(itineraryId.data,function(err){
            debugger;
            if(err){
                if (err) {
                    self.state.alert.alert(err);
                }
            }
            else {
                self.state.alert.alert(null);
            }
            $patchChanges();
        });
    }
</script>