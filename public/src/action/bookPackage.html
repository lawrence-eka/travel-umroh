<inject from="/component/card-booking" name="card-booking"></inject>
<inject from="/component/card-passenger" name="card-passenger"></inject>
<inject from="/component/alert" name="alert"></inject>
<link href="asset/css/registration.css" rel="stylesheet">

<div>
	<div if.bind="errorMessage != ''">
	    {{errorMessage}}
	</div>

	<div data.load="queryBooking($bookingId)">
		<card-booking bkg.bind="data" ></card-booking>
	</div>

	<div class="container all-5px">
		<div class="row centered-form no-top-margin">
			<div class="form-panel col-xs-12 col-sm-12 col-md-12 col-lg-12">
				<div class="panel panel-default">
					<div class="panel-heading">
						<h3 class="panel-title">Passenger Detail</h3>
					</div>
					<div class="panel-body">
						<div if.bind="errorMessage" class="form-control" >
							{{errorMessage}}
						</div>
						<form role="form" submit.trigger="register(this)">
							<div class="row">
								<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
									<div class="form-group">
										<input type="text" name="firstName" class="form-control input-sm" placeholder="First Name">
									</div>
								</div>
								<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
									<div class="form-group">
										<input type="text" name="middleName" class="form-control input-sm" placeholder="Middle Name">
									</div>
								</div>
								<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
									<div class="form-group">
										<input type="text" name="lastName" class="form-control input-sm" placeholder="Last Name">
									</div>
								</div>
							</div>

							<div class="row">
								<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
									<div class="form-group">
										<input type="text" name="birthPlace" class="form-control input-sm" placeholder="Birth Place">
									</div>
								</div>
								<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
									<div class="form-group">
										<input type="date" name="birthday" class="form-control input-sm" placeholder="birthday">
									</div>
								</div>
							</div>
							<div class="form-group">
								<input type="text" name="passportNumber" class="form-control input-sm" placeholder="Passport Number">
							</div>
							<div class="form-group">
								<input type="date" name="passportExpiryDate" class="form-control input-sm" placeholder="Passport Expiry Date">
							</div>
							<div class="form-group">
								<input type="text" name="passportIssuer" class="form-control input-sm" placeholder="Passport Issuer">
							</div>

							<input type="submit" value="Register" class="btn btn-info btn-block btn-default">

						</form>
						<div class="form-group">
							<input type="button" value="Payment Detail" class="form-control btn btn-info btn-block margin-top-15px" click.trigger="calculatePaymentDetail($bookingId)">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div data.load="getPassengers($bookingId)">
	<p for.each="psg in data">
		<card-passenger passenger.bind="psg"></card-passenger>
	</p>
</div>

<script>
    var dates = $inject('/common/dates');
    var numbers = $inject('/common/numbers');
    var obj = $inject('/common/objects');

    //var costLA = 0;
    //var costTickets = 0;

    var package = {};
    var booking = {};

    //var numOfPassenger = 0;
    var errorMessage = '';

    function setPackage(pkg) {
    	package = pkg;
    }

    function getPackage() {
    	return package;
    }

    function setBooking(bkg) {
    	var nop = booking.numberOfPassengers?booking.numberOfPassengers:0;
    	booking = bkg; 
    	booking.numberOfPassengers = nop;
    }

    function setNumberOfPassengers(numberOfPassengers) {
    	booking.numberOfPassengers = numberOfPassengers
    }
    function getBooking() {
    	return booking;
    }

    function calculatePaymentDetail(bookingId) {
        booking.uniqueCode = Math.floor(Math.random() * 1000);
        booking.waitingForPaymentUntil = (new Date()).getTime() + 10800000;
        dpd.bookings.put(booking, function(bkg, err) {
            if(err){
                errorMessage = err.message;
            } else {
                window.location.hash = '#app/action.paymentDetails:bookingId=' + bookingId;
            }
            $patchChanges();
        });
   }

    function getPassengers(bookingId) {
    	//debugger;
    	return new Promise(function(resolve) {
	    	dpd.passengers.get({"bookingId":bookingId}, function(passengers, err)
	    	{
                if(err){
                    errorMessage = JSON.stringify(err);
                }else {
                	//numOfPassenger = passengers.length;
                	//booking.numBeRofpassengers = passengers.length;
                	setNumberOfPassengers(passengers.length);
                    resolve(passengers);
                }
	    	});
	    });
    }

    function registerPassenger(form){
    	//booking.uniqueCode = Math.floor(Math.random() * 1000);
    	booking.totalPrice = booking.numberOfPassengers * (booking.costTickets + booking.costLandArrangements);
        dpd.bookings.put(booking, function(booking, err) {
            if(err){
                errorMessage = err.message;
                $patchChanges();
            } else {
            }
        });

    	var q = {};
    	q.bookingId = form.elements.bookingId.value;
        q.firstName = form.elements.firstName.value;
        q.middleName = form.elements.middleName.value;
        q.lastName = form.elements.lastName.value;
        q.birthPlace = form.elements.birthPlace.value;
        q.birthday = (new Date(form.elements.birthday.value)).getTime();
        q.passportNumber = form.elements.passportNumber.value;
        q.passportIssuer = form.elements.passportIssuer.value;
        q.passportExpiryDate = (new Date(form.elements.passportExpiryDate.value)).getTime();

    	form.elements.bookingId.value = "";
        form.elements.firstName.value = "";
        form.elements.middleName.value = "";
        form.elements.lastName.value = "";
        form.elements.birthPlace.value = "";
        form.elements.birthday.value = "";
        form.elements.passportNumber.value = "";
        form.elements.passportExpiryDate.value = "";

        dpd.passengers.post(q, function(user, err) {
            if(err){
                errorMessage = JSON.stringify(err);
            }
            $patchChanges();
        });
	    return false;
    }

    function queryBooking(id){
    	return new Promise(function(resolve){
    		dpd.bookings.get(id, function(bkg, err) {
    			if(err) {
    				errorMessage = JSON.stringify(err);
    			} else {
    			    resolve(bkg);
    				setBooking(bkg);
    			}
    		});
    	});
    }
</script>