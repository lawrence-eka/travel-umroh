<inject from="/component/entry" name="entry"></inject>
<inject from="/component/alert" name="alert"></inject>
<inject from="/component/card-package" name="card-package"></inject>
<link href="asset/css/custom-style.css" rel="stylesheet">

<div class="container all-5px">
    <div class="row centered-form no-top-margin">
        <div class="form-panel col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="panel panel-default frosted-glass">
                <div class="panel-heading">
                    <h3 class="panel-title">Search Packages</h3>
                </div>
                <div class="panel-body">
                    <form role="form">
                        <div class="row">
                            <entry type="date" prompt="Between" name="startDate" value.bind="_startDate"></entry>
                            <entry type="date" prompt="And" name="endDate" value.bind="_endDate"></entry>
                            <entry type="button" name="Search" value="Search" click.trigger="search()"></entry>
                        </div>
                        <alert alertType.bind="messageType" message.bind="message"></alert>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div data.load="queryPackages()">
        <div class="row">
            <div class="col-md-4 col-sm-6" for.each="pkg in data" >
                <card-package click.trigger="generateLink(event)" pkg.bind="pkg"></card-package>
            </div>
        </div>
    </div>
</div>

<script>
    var message = '';
    var messageType ='';
    var _startDate = (new Date()).toYYYYMMDD();
    var _endDate = ((new Date()).getTime() + 31536000000).toYYYYMMDD();
    var numOfPackagesFound='';

    function generateLink(event){
        window.location.hash = '#app/action.showPackage:packageId='+event.data;
    }

    function queryPackages(){
        return new Promise(function(resolve){
            //var form = formGlobal;
            if(_startDate == "" || _endDate == "") resolve([]);
            var startDate = new Date(_startDate + " 00:00:00");
            var endDate = new Date(_endDate + " 23:59:59");
            var query = {};
            query.isPublished = "true";
            query.validUntil = {"$gte": (new Date()).getTime()};
            query.$and = [
                {travelDateFrom: {"$gte": startDate.getTime()}},
                {travelDateFrom: {"$lte": endDate.getTime()}}
            ];
            query.$sort={"travelDateFrom":1};
            dpd.packages.get(query, function(pkg, err) {
                if(err){
                    message = err;
                    messageType = "error";
                }else {
                	message = (pkg.length > 0 ? pkg.length.toString() + ' package' +(pkg.length == 1 ? '' : 's') : 'No package') + ' found';
                	messageType = "info";
                }
	            resolve(pkg);
                $patchChanges();
            });
        });

    }

    function search(){
    	var form = this.target.form;
        _startDate = form.elements.startDate.value;
        _endDate = form.elements.endDate.value;
        $patchChanges();
        return false;
    }
</script>

