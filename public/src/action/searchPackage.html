<inject from="/component/panel" name="panel"></inject>
<inject from="/component/entry" name="entry"></inject>
<inject from="/component/alert" name="alert"></inject>
<inject from="/component/card-package" name="card-package"></inject>
<link href="asset/css/custom-style.css" rel="stylesheet">

<div>
    <panel title="Search Packages" nofooter>
        <div slot.name="body">
            <form>
                <entry type="date" prompt="Between" name="startDate" value.bind="_startDate"></entry>
                <entry type="date" prompt="And" name="endDate" value.bind="_endDate"></entry>
                <entry type="button" name="Search" value="Search" click.trigger="search()"></entry>
            </form>
        </div>
    </panel>
    <div>
        <alert alertType.bind="messageType" message.bind="message"></alert>
    </div>
    <div data.load="queryPackages()">
        <div for.each="pkg in data" >
            <card-package click.trigger="generateLink(event)" pkg.bind="pkg"></card-package>
        </div>
    </div>
</div>

<script>
    var message = '';
    var messageType ='';
    var _startDate = (new Date()).toYYYYMMDD();
    var _endDate = ((new Date()).getTime() + 31536000000).toYYYYMMDD();
    var numOfPackagesFound='';

    function generateLink(event){
        window.location.hash = '#app/action.showPackage:packageId='+event.data;
    }

    function queryPackages(){
        return new Promise(function(resolve){
            //debugger;
            if(_startDate == "" || _endDate == "") resolve([]);
            var startDate = (new Date(_startDate)).setHours(0,0,0,0);
            var endDate = (new Date(_endDate)).setHours(23,59,59,999);
            var query = {};
            query.isPublished = "true";
            query.validUntil = {"$gte": (new Date()).getTime()};
            query.$and = [
                {travelDateFrom: {"$gte": startDate}},
                {travelDateFrom: {"$lte": endDate}}
            ];
            query.$sort={"travelDateFrom":1};
            dpd.packages.get(query, function(pkg, err) {
	            //debugger;
                if(err){
                    message = err;
                    messageType = "error";
                }else {
                	message = (pkg.length > 0 ? pkg.length.toString() + ' package' +(pkg.length == 1 ? '' : 's') : 'No package') + ' found';
                	messageType = "info";
                }
	            $patchChanges();
	            resolve(pkg);
            });
        });

    }

    function search(){
    	var form = this.target.form;
        _startDate = form.elements.startDate.value;
        _endDate = form.elements.endDate.value;
        $patchChanges();
        return false;
    }
</script>

