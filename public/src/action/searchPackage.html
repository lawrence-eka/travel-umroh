<inject from="/component/panel" name="panel"></inject>
<inject from="/component/entry" name="entry"></inject>
<inject from="/component/alert" name="alert"></inject>
<inject from="/component/card-package" name="card-package"></inject>
<link href="asset/css/custom-style.css" rel="stylesheet">

<div>
    <panel title="Search Packages" footer.bind="@recordsFound">
        <div slot.name="body">
            <form>
                <entry type="date" prompt="Between" name="startDate" value.bind="@date.start"></entry>
                <entry type="date" prompt="And" name="endDate" value.bind="@date.end"></entry>
                <entry type="button" name="Search" value="Search" click.trigger="search()"></entry>
            </form>
        </div>
    </panel>
    <div>
        <alert alertType.bind="@alert.type" message.bind="@alert.text"></alert>
    </div>
    <div data.load="queryPackages()">
        <div for.each="pkg in data" >
            <card-package click.trigger="generateLink(event)" pkg.bind="pkg"></card-package>
        </div>
    </div>
</div>

<script>
    function initState(props) {
        return {
            recordsFound: '',
            alert:{
                text: '',
                type:''
            },
            date: {
                start: (new Date()).toYYYYMMDD(),
                end: ((new Date()).getTime() + 31536000000).toYYYYMMDD()
            }
        };
    }

    function generateLink(event){
        window.location.hash = '#app/action.showPackage:packageId='+event.data;
    }

    function queryPackages(){
        var self = this;
        return new Promise(function(resolve){
            if(self.state.date.start == "" || self.state.date.end == "") resolve([]);
            var startDate = (new Date(self.state.date.start)).setHours(0,0,0,0);
            var endDate = (new Date(self.state.date.end)).setHours(23,59,59,999);
            var query = {};
            query.isPublished = "true";
            query.validUntil = {"$gte": (new Date()).getTime()};
            query.$and = [
                {travelDateFrom: {"$gte": startDate}},
                {travelDateFrom: {"$lte": endDate}}
            ];
            query.$sort={"travelDateFrom":1};
            dpd.packages.get(query, function(pkg, err) {
	            //debugger;
                if(err){
                    self.state.alert.text = err;
                    self.state.alert.type = "error";
                    self.state.recordsFound = "";
                }else {
                	self.state.recordsFound = (pkg.length > 0 ? pkg.length.toString() + ' package' +(pkg.length == 1 ? '' : 's') : 'No package') + ' found';
                }
	            resolve(pkg);
            });
        });

    }

    function search(){
    	var form = this.target.form;
        this.state.date.start = form.elements.startDate.value;
        this.state.date.end = form.elements.endDate.value;
        $patchChanges();
        return false;
    }
</script>

