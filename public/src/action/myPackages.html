<link href="asset/css/custom-style.css" rel="stylesheet">
<inject from="/component/entry" name="entry"></inject>
<inject from="/component/panel" name="card"></inject>
<inject from="/component/card-package" name="card-package"></inject>
<inject from="/component/edit-package" name="edit-package"></inject>

<div>
    <div data.load="getTravelAgentName($travelAgentId)">
        <card title.bind="data.travelAgentName" nofooter>
            <div slot.name="body">
                <entry type="button" value="New Package" click.trigger="onNewPackage($travelAgentId)" if.bind="!$editPackageId"></entry>
            </div>
        </card>
        <edit-package if.bind="$editPackageId == -1" save.trigger="onSavePackage(event, $travelAgentId)" cancel.trigger="onCancelEdit($travelAgentId)"></edit-package>
        <div data.load="getPackages($travelAgentId)">
            <div for.each="pkg in data">
                <card-package if.bind="$editPackageId != pkg.id" pkg.bind="pkg" edit.trigger="onEditPackage(event, $travelAgentId)" showItinerary.trigger="onShowItinerary(event)"></card-package>
                <edit-package if.bind="$editPackageId == pkg.id" package.bind="pkg" save.trigger="onSavePackage(event, $travelAgentId)" cancel.trigger="onCancelEdit($travelAgentId)"></edit-package>
            </div>
        </div>
    </div>
</div>
<script>
    function getTravelAgentName(id) {
	    return new Promise(function (resolve) {
		    dpd.travelagents.get(id, function (ta, err) {
			    if(err) {
				    errorMessage = err.message;
				    $patchChanges();
			    } else {
				    resolve(ta);
			    }
		    });
	    });
    }

    function getPackages(travelAgentId){
    	return new Promise(function(resolve){
    		var q = {
    			"travelAgentId": travelAgentId
            }
    		dpd.packages.get(q, function(result, err){
    			resolve(result);
            });
        });0
    }

    function onCancelEdit(travelAgentId) {
    	debugger;
	    window.location.hash="#app/action.myPackages:travelAgentId=" + travelAgentId;
    }

    function onSavePackage(pkg, travelAgentId) {
    	debugger;
    	pkg = pkg.data;
    	pkg.travelAgentId = travelAgentId;
    	dpd.packages.post(pkg, function(result,err){
		    window.location.hash="#app/action.myPackages:travelAgentId=" + travelAgentId;
    		$patchChanges();
        });
    }
    function onEditPackage(packageId, travelAgentId) {
    	debugger;
	    window.location.hash="#app/action.myPackages:travelAgentId=" + travelAgentId + ":editPackageId=" + packageId.data;
    }
    function onShowItinerary(packageId) {
    	debugger;
	    window.location.hash="#app/action.myItinerary:packageId=" + packageId.data;
    }

    function onNewPackage(event) {
    	debugger;
	    window.location.hash="#app/action.myPackages:travelAgentId=" + event + ":editPackageId=-1";
    }
</script>