<link href="asset/css/registration.css" rel="stylesheet">
<inject from="/component/card" name="card"></inject>
<inject from="/component/card-package" name="card-package"></inject>
<inject from="/component/edit-package" name="edit-package"></inject>

<div data.load="getTravelAgentName($travelAgentId)">
    <card title.bind="data.travelAgentName">
        <input type="button" value="New Package" class="form-control btn btn-info btn-block" click.trigger="onNewPackage($travelAgentId)" if.bind="!$editPackageId">
    </card>
    <edit-package if.bind="$editPackageId == -1" save.trigger="onSavePackage(event, $travelAgentId)" cancel.trigger="onCancelEdit($travelAgentId)"></edit-package>
    <div data.load="getPackages($travelAgentId)">
        <div for.each="pkg in data">
            <card-package if.bind="$editPackageId != pkg.id" pkg.bind="pkg" edit.trigger="onEditPackage(event, $travelAgentId)" showItinerary.trigger="onShowItinerary(event)"></card-package>
            <edit-package if.bind="$editPackageId == pkg.id" package.bind="pkg" save.trigger="onSavePackage(event, $travelAgentId)" cancel.trigger="onCancelEdit($travelAgentId)"></edit-package>
        </div>
    </div>

</div>

<script>
    function getTravelAgentName(id) {
	    return new Promise(function (resolve) {
		    dpd.travelagents.get(id, function (ta, err) {
			    if(err) {
				    errorMessage = err.message;
				    $patchChanges();
			    } else {
				    resolve(ta);
			    }
		    });
	    });
    }

    function getPackages(travelAgentId){
    	return new Promise(function(resolve){
    		var q = {
    			"travelAgentId": travelAgentId
            }
    		dpd.packages.get(q, function(result, err){
    			resolve(result);
            });
        });0
    }

    function onCancelEdit(travelAgentId) {
	    window.location.hash="#app/action.myPackages:travelAgentId=" + travelAgentId;
    }

    function onSavePackage(pkg, travelAgentId) {
    	pkg.travelAgentId = travelAgentId;
    	alert(JSON.stringify(pkg));
    }
    function onEditPackage(packageId, travelAgentId) {
	    window.location.hash="#app/action.myPackages:travelAgentId=" + travelAgentId + ":editPackageId=" + packageId;
    }
    function onShowItinerary(packageId) {
	    window.location.hash="#app/action.myItinerary:packageId=" + packageId;
    }

    function onNewPackage(travelAgentId) {
	    window.location.hash="#app/action.myPackages:travelAgentId=" + travelAgentId + ":editPackageId=-1";
    }
</script>