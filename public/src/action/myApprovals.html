<inject from="/component/card-user-approvals" name="card-user-approvals"></inject>
<inject from="/component/alert" name="alert"></inject>
<link href="asset/css/registration.css" rel="stylesheet">

<div data.load="loadUserApprovals()">
    <alert message.bind="errorMessage" alertType.bind="alertType"></alert>
    <alert message.bind="'No user needs approval for now.'" alertType.bind="'info'" if.bind="!data || data.length==0"></alert>
    <p for.each="user in data">
        <card-user-approvals user.bind="user" approve.trigger="onApprove(event, true)" reject.trigger="onApprove(event, false)"></card-user-approvals>
    </p>
</div>

<script>
	var errorMessage ="";
	var alertType="";
	function loadUserApprovals() {
		return new Promise(function(resolve) {
			var q = {
				"needApproval": {"$ne": null}
			};
			dpd.users.get(q, function (users, err) {
				if (err) {
					errorMessage = err.message;
				} else {
					resolve(users);
				}
				$patchChanges();
			});
		});
	}

	function onApprove(user, isApproved) {
		return new Promise(function(resolve){
			if(isApproved) user.needApproval.isApproved=true;
			else user.needApproval=false;
			dpd.users.put(user.id, user, function(result,err){
				if(err)
                {
                	errorMessage = JSON.stringify(err);
                	alertType="error";
                }
				window.location.hash ="#app/action.myApprovals";
            });
        });
	}
</script>