<inject from="/component/card-booking" name="card-booking"></inject>
<inject from="/component/panel" name="card"></inject>
<link href="asset/css/custom-style.css" rel="stylesheet">
<inject from="/component/entry" name="entry"></inject>

<div>
            <div data.load="getPaymentDetails($bookingId)" >
                <card-booking bkg.bind="data"></card-booking>
                <card title="Payment Info" footer="Please make the payment before booking expires to avoid automatic cancellation of your booking">
                    <div slot.name="body">
                        Total: {{(booking.totalPrice + booking.uniqueCode).toFormattedString()}}<br/>
                        Bank: Bank Central Asia<br/>
                        Branch: Sidoarjo<br/>
                        Account No:1234567890<br/>
                        Name: PT Pete Tbk.<br/>
                    </div>
                </card>
            </div>
            <card title="Payment Confirmation" nofooter>
                <div slot.name="body">
                    <form>
                        <div class="row">
                            <entry type="text" prompt="Bank Name" name="fromBank"></entry>
                            <entry type="text" prompt="Bank Branch" name="fromBranch"></entry>
                            <entry type="text" prompt="Account Number" name="fromAccountNumber"></entry>
                            <entry type="text" prompt="Account Holder" name="fromAccountHolder"></entry>
                            <entry type="number" prompt="Amount Transfered" name="actualPayment"></entry>
                            <entry type="datetime-local" prompt="Transfer Date & Time" name="paymentDate"></entry>
                            <entry type="button" name="btnPaymentConfirmation" value="Payment Confirmation" click.trigger="paymentConfirmation()"></entry>
                        </div>
                    </form>
                </div>
        </card>
</div>
<script>
    var dates = $inject('/common/dates');
    var numbers = $inject('/common/numbers');
	var errorMessage="";

    var package = {};
    var booking = {};

    function setPackage(pkg) {
    	package = pkg;
    }

    function getPackage() {
    	return package;
    }

    function setBooking(bkg) {
    	booking = bkg; 
    }

    function getBooking() {
    	return booking;
    }

    function paymentConfirmation() {
    	debugger;
	    var form = this.target.form;
    	booking.fromBank = form.elements.fromBank.value;
    	booking.fromBranch = form.elements.fromBranch.value;
    	booking.fromAccountNumber  = form.elements.fromAccountNumber.value;
    	booking.fromAccountHolder = form.elements.fromAccountHolder.value;
    	booking.actualPayment = form.elements.actualPayment.value;
    	booking.paymentDate = (new Date(form.elements.paymentDate.value)).getTime();
		doPaymentConfirmation();
        return false;
    }

    function doPaymentConfirmation() {
        return new Promise(function(resolve){
	        dpd.bookings.put(booking, function(bkg, err) {
	            if(err){
	                errorMessage = JSON.stringify(err);
	                $patchChanges();
	            } else {
			        window.location.hash = '#app/action.paymentConfirmation:bookingId=' + booking.id;
	            }
	        });
        });
    }

    function queryTravelAgent(id) {
        return new Promise(function(resolve){
            dpd.travelagents.get(id, function(agent, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                }else {
                    resolve(agent);
                }
            });
        });
    }

    function queryPackage(id){
    	
        return new Promise(function(resolve){
            dpd.packages.get(id, function(pkg, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                }else {
                    queryTravelAgent(pkg.travelAgentId).then(function(agent){
                        pkg.agent = agent;
                        resolve(pkg);
                    });
                }
            });
        });
    }

	function getPaymentDetails(bookingId) {
        return new Promise(function(resolve) {
            dpd.bookings.get(bookingId, function(bkg, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                } else {
                	setBooking(bkg);
    				queryPackage(bkg.packageId).then(function(pkg){
    					setPackage(pkg);
    					bkg.package = pkg;
    					//debugger;
                        resolve(bkg);
    				});
                }
            });

        });
    }
</script>