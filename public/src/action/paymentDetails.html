<inject from="/component/card-booking" name="card-booking"></inject>
<inject from="/component/card" name="card"></inject>

<div if.bind="errorMessage">
    {{errorMessage}}
</div>
<div data.load="getPaymentDetails($bookingId)">
    <card-booking bkg.bind="data"></card-booking>
    <card title="Payment Info" remarks="Please make the payment before booking expires to avoid automatic cancellation of your booking">
        <div>
            Total: {{numbers.money(booking.totalPrice + booking.uniqueCode)}}<br/>
            Bank: Bank Central Asia<br/>
            Branch: Sidoarjo<br/>
            Account No:1234567890<br/>
            Name: PT Pete Tbk.<br/>
        </div>
    </card>

    <div class="container all-5px">
        <div class="row centered-form no-top-margin">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Payment Confirmation</h3>
                    </div>
                    <div class="panel-body">
                        <div if.bind="errorMessage" class="form-control" >
                            {{errorMessage}}
                        </div>
                        <form role="form" submit.trigger="paymentConfirmation(this)">
                            <div class="row">
                                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                    <div class="form-group">
                                        <input type="text" name="fromBank" class="form-control input-sm" placeholder="Bank Name">
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                    <div class="form-group">
                                        <input type="text" name="fromBranch" class="form-control input-sm" placeholder="Branch">
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                    <div class="form-group">
                                        <input type="text" name="fromAcountNumber" class="form-control input-sm" placeholder="Account Number">
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                    <div class="form-group">
                                        <input type="text" name="fromAcountHolder" class="form-control input-sm" placeholder="Account Holder Name">
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                    <div class="form-group">
                                        <input type="number" name="actualPayment" class="form-control input-sm" placeholder="Amount Transfered">
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                    <div class="form-group">
                                        <input type="datetime-local" name="paymentDate" class="form-control input-sm" placeholder="Transfer Date & Time">
                                    </div>
                                </div>
                            </div>
                            <input type="submit" value="Payment Confirmation" class="btn btn-info btn-block btn-default">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var dates = $inject('/common/dates');
    var numbers = $inject('/common/numbers');
	var errorMessage="";

    var package = {};
    var booking = {};

    function setPackage(pkg) {
    	package = pkg;
    }

    function getPackage() {
    	return package;
    }

    function setBooking(bkg) {
    	booking = bkg; 
    }

    function getBooking() {
    	return booking;
    }

    function paymentConfirmation(form) {
    	booking.fromBank = form.elements.fromBank.value;
    	booking.fromBranch = form.elements.fromBranch.value;
    	booking.fromAccountNumber  = form.elements.fromAccountNumber.value;
    	booking.fromAccountHolder = form.elements.fromAccountHolder.value;
    	booking.actualPayment = form.elements.actualPayment.value;
    	booking.paymentDate = (new Date(form.elements.paymentDate.value)).getTime();
		doPaymentConfirmation();
        return false;
    }

    function doPaymentConfirmation() {
        return new Promise(function(resolve){
	        dpd.bookings.put(booking, function(bkg, err) {
	            if(err){
	                errorMessage = JSON.stringify(err);
	                $patchChanges();
	            } else {
			        window.location.hash = '#app/action.paymentConfirmation:bookingId=' + booking.id;
	            }
	        });
        });
    }

    function queryTravelAgent(id) {
        return new Promise(function(resolve){
            dpd.travelagents.get(id, function(agent, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                }else {
                    resolve(agent);
                }
            });
        });
    }

    function queryPackage(id){
    	
        return new Promise(function(resolve){
            dpd.packages.get(id, function(pkg, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                }else {
                    queryTravelAgent(pkg.travelAgentId).then(function(agent){
                        pkg.agent = agent;
                        resolve(pkg);
                    });
                }
            });
        });
    }

	function getPaymentDetails(bookingId) {
        return new Promise(function(resolve) {
            dpd.bookings.get(bookingId, function(bkg, err) {
                if(err){
                    errorMessage = JSON.stringify(err);
                    $patchChanges();
                } else {
                	setBooking(bkg);
    				queryPackage(bkg.packageId).then(function(pkg){
    					setPackage(pkg);
    					bkg.package = pkg;
    					//debugger;
                        resolve(bkg);
    				});
                }
            });

        });
    }
</script>