<inject from="/component/alert" name="alert"></inject>
<inject from="/component/entry" name="entry"></inject>
<inject from="/component/panel" name="panel"></inject>
<inject from="/component/ppLink" name="ppLink"></inject>
<inject from="/component/attachments/home" name="attachments"></inject>

<div >
    <panel title.bind="whatTitle($profile)">
        <div slot.name="footer">
            <ppLink></ppLink>
        </div>
        <div slot.name="body" data.load="loadProfile($profile)">
                <form>
                    <div class="row" ref.name="alert">
                        <input type="hidden" name="id" value.bind="data.id">
                        <entry type="text" prompt="First Name" name="firstName" value.bind="data.firstName"></entry>
                        <entry type="text" prompt="Last Name" name="lastName" value.bind="data.lastName"></entry>

                        <entry type="hidden" prompt="username" name="username" value.bind="data.username"></entry>
                        <entry type="email" prompt="Email" name="email" value.bind="data.email" alias="username" alert.bind="@alert"></entry>
                        <entry type="text" prompt="Phone" name="phone" value.bind="data.phone"></entry>

                        <entry type="textarea" prompt="Address" name="address1" value.bind="data.address1"></entry>

                        <entry type="text" prompt="City" name="city" value.bind="data.city"></entry>

<!--
                        <entry type="checkbox" prompt="Administrator" name="isAdmin" checked.bind="data.isAdmin"></entry>
                        <entry type="checkbox" prompt="Travel Agent" name="isTravelAgent" checked.bind="data.isTravelAgent" click.trigger="onTravelAgentClick(event)"></entry>
-->

                        <div if.bind="!gotNeedApproval(data, 'isAdmin')">
                            <entry type="checkbox" prompt="Administrator" name="isAdmin" checked.bind="data.isAdmin"></entry>
                        </div>
                        <div if.bind="gotNeedApproval(data, 'isAdmin')">
                            <entry type="checkbox" prompt="Administrator*" name="isAdmin" checked.bind="data.needApproval.isAdmin"></entry>
                            <entry type="label" prompt.bind="('*' + (data.needApproval.isAdmin ? 'Request for' : 'Revokal of') + ' Admin Access under review')"></entry>
                        </div>
                        <div if.bind="!gotNeedApproval(data, 'isTravelAgent')">
                            <entry type="checkbox" prompt="Travel Agent" name="isTravelAgent" checked.bind="data.isTravelAgent" click.trigger="onTravelAgentClick(event)"></entry>
                        </div>
                        <div if.bind="gotNeedApproval(data, 'isTravelAgent')">
                            <entry type="checkbox" prompt="Travel Agent*" name="isTravelAgent" checked.bind="data.needApproval.isTravelAgent" click.trigger="onTravelAgentClick(event)"></entry>
                            <entry type="label" prompt.bind="('*' + (data.needApproval.isTravelAgent ? 'Request for' : 'Revokal of') + ' Travel Agent Access under review')"></entry>
                        </div>
                    </div>
                    <div ref.name="docsTravelAgent">
                        <div class="row" if.bind="@showDocsTravelAgent">
                            <attachments userId.bind="data.id" prompt="Proof of Travel Agency" collection="docstravelagent" onSave.bind="@onSave"></attachments>
                        </div>
                    </div>
                    <div class="row" ref.name="alert">
                        <entry type="password" prompt="Password" name="password" value.bind="data.password" alert.bind="@alert"></entry>
                        <entry type="password" prompt="Repeat Password" name="repeatPassword" alert.bind="@alert"></entry>
                        <entry type="button" name="btnSave" value.bind="$profile ? 'Save' : 'Register'" divClass="col-xs-6 col-sm-6 col-md-6 col-lg-6" click.trigger="onRegister()"></entry>
                        <entry type="button" name="btnCancel" value="Cancel" divClass="col-xs-6 col-sm-6 col-md-6 col-lg-6" click.trigger="onCancel()"></entry>
                    </div>
                </form>
                <alert alertType.bind="@alert.type()" message.bind="@alert.text()"></alert>
            </span>
        </div>
    </panel>
</div>

<script>

    function initState(props) {
    	//debugger;
        if(props.onSaved) props.onSaved.subscribe(onSaved.bind(this));
        var state = {
        	alert: new Alert(null, $patchChanges, "alert"),
            originalProfile: null,
            onSave: new Event(),
	        showDocsTravelAgent: false,

        };
        state.alert.alert(props.error);
        return state;
    }

    function onPropertyChange(event) {
    	//debugger;
        if(event.error) this.state.alert.alert(event.error.newValue);
    }

    function gotNeedApproval(profile, which) {
    	return (profile.needApproval && profile.needApproval.hasOwnProperty(which));
    }

    function loadProfile(profile){
	    profile = (profile? profile : {});
    	this.state.originalProfile = profile;
    	this.state.showDocsTravelAgent = (profile.isTravelAgent || (profile.needApproval && profile.needApproval.isTravelAgent));
        return this.state.originalProfile;
    }

    function whatTitle(profile) {
    	if(!profile) return "Please Sign Up";
    	else if(profile.id == storage.me.read().id) return "Your Profile";
    	else return "User Profile";
    }
    function onTravelAgentClick(event) {
    	debugger;
	    this.state.showDocsTravelAgent = event.data;
    	$patchChanges("docsTravelAgent");
    }
    function onRegister(){
        this.state.alert.alert('');
        var form = this.target.form;

        if(form.elements.password.value != form.elements.repeatPassword.value ) {
            this.state.alert.alert({name: "repeatPassword", message: "Please repeat your password correctly"});
            return;
        }

	    var profile = this.state.originalProfile;
        profile.id = form.elements.id.value;
        profile.firstName = form.elements.firstName.value;
        profile.lastName = form.elements.lastName.value;
        profile.email = form.elements.email.value;
        profile.phone = form.elements.phone.value;
        profile.username = form.elements.email.value;

        if(profile.username) profile.username = profile.username.toLowerCase();
        if(form.elements.password.value != '') profile.password = form.elements.password.value;

        debugger;
        profile.address1 = form.elements.address1.value;
        profile.city = form.elements.city.value;
        if((profile.isAdmin ? true : false) != form.elements.isAdmin.checked) {
        	profile.isAdmin = (form.elements.isAdmin.checked);
        } else {
        	delete profile.isAdmin;
	        if(profile.needApproval) delete profile.needApproval.isAdmin;
        }

	    if((profile.isTravelAgent ? true : false) != form.elements.isTravelAgent.checked) {
        	profile.isTravelAgent = (form.elements.isTravelAgent.checked);
	    } else {
        	delete profile.isTravelAgent;
		    if(profile.needApproval) delete profile.needApproval.isTravelAgent;
	    }

	    if(profile.needApproval && !profile.needApproval.hasOwnProperty('isAdmin') && !profile.needApproval.hasOwnProperty('isTravelAgent')) {
	    	profile.needApproval = null;
        }
        debugger;
        if(profile.id) this.state.onSave.publish();;

	    this.emitEvent('save', profile);
    }

    function onCancel() {
        this.emitEvent('cancel');
    }

    function onSaved() {
    	debugger;
	    this._state.onSave.publish();
    }

</script>

