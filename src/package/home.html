<inject from="/package/list" name="list"></inject>
<inject from="/package/edit-package" name="edit-package"></inject>
<inject from="/component/entry" name="entry"></inject>
<inject from="/component/panel" name="panel"></inject>

<div data.load="getTravelAgent()">
    <edit-package if.bind="@isEditMode" travelAgentId.bind="@travelAgentId" packageId.bind="@editPackageId" close.trigger="onCloseEditor()"></edit-package>
    <span if.bind="!@isEditMode" >
        <panel title.bind="data.travelAgentName" nofooter>
            <span slot.name="body">
                <entry type="button" naked value="Add New Package" click.trigger="onAddPackage()"></entry>
            </span>
        </panel>
        <list travelAgentId.bind=@travelAgentId" editPackage.trigger="onEditPackage(event)" showItinerary.trigger="onShowItinerary(event)"></list>
    </span>
</div>

<script>

    function initState(props) {
    	return {
		    travelAgentId:props.travelAgentId,
		    editPackageId:null,
            isEditMode: false,
            alert: new Alert(),
        }
    }

    function getTravelAgent() {
    	var self = this;
	    return new Promise(function (resolve) {
		    dpd.travelagents.get(self.state.travelAgentId, function (ta, err) {
			    self.state.alert.alert(err);
                resolve(ta);
		    });
	    });
    }

    function onCloseEditor() {
	    this.state.editPackageId=null;
	    this.state.isEditMode=false;
	    $patchChanges();
    }

    function onEditPackage(packageId) {
    	this.state.editPackageId = packageId.data;
	    this.state.isEditMode=true;
    	$patchChanges();
    }

    function onShowItinerary(packageId) {
	    window.location.hash="#app/itinerary.home:packageId=" + packageId.data;
    }

    function onAddPackage() {
    	this.state.editPackageId=null;
	    this.isEditMode=true;
    	$patchChanges();
    }
</script>