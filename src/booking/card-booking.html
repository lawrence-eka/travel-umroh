<inject from="/component/panel" name="card"></inject>
<inject from="/component/alert" name="alert"></inject>
<inject from="/component/entry" name="entry"></inject>

<div>
    <card click.trigger="onClick()" title.bind="'Package: ' + @booking.package.packageName">
        <div slot.name="body">
            Travel Date: {{(@booking.package.travelDateFrom).toStringDateRange(@booking.package.travelDateUntil)}}<br/>
            Operator: {{@booking.travelAgent.travelAgentName}}<br/>
            Land Arrangements: {{@booking.costLandArrangements ? @booking.costLandArrangements.toFormattedString() : ''}}<br/>
            Tickets: {{@booking.costTickets ? @booking.costTickets.toFormattedString() : ''}}<br/>
            Total passenger: {{@booking.numberOfPassengers ? @booking.numberOfPassengers : ''}}<br/>
            Total Price: {{(@booking.totalPrice ? @booking.totalPrice.toFormattedString() : '')}}<br/>
            Unique Code: {{@booking.uniqueCode ? @booking.uniqueCode : ''}}<br/>
            Grand Total: {{(@booking.totalPrice + @booking.uniqueCode) ? (@booking.totalPrice + @booking.uniqueCode).toFormattedString() : ''}}<br/>
            Expiry Date: {{(@booking.waitingForPaymentUntil ? @booking.waitingForPaymentUntil.toDateComponents(false, true) : '')}}<br/>
            <div if.bind="!@showOnly">
                <div class="row">
                    <entry type="button" name="btnSave" value.bind="@status.code == @bookingUtils.definingPassengers ? 'Save for Later' : 'Close'" divClass="col-xs-6 col-sm-6 col-md-6 col-lg-6" click.trigger="onSaveBooking()"></entry>
                    <entry type="button" if.bind="@status.code == @bookingUtils.definingPassengers || @status.code == @bookingUtils.waitingForPayment" name="btnCancel" value="Cancel Booking" divClass="col-xs-6 col-sm-6 col-md-6 col-lg-6" click.trigger="onCancelBooking()"></entry>
                    <entry type="button" name="btnPassengers" value="Passengers..." click.trigger="onEditPassenger()"></entry>
                    <entry type="button" name="btnPaymentDetail" value.bind="(@status.code==@bookingUtils.definingPassengers ? 'Next Step: ' : '') + 'Payment Detail'" click.trigger="calculatePaymentDetail()"></entry>
                </div>
            </div>
        </div>
        <div slot.name="footer">
            <strong>Status: {{@status.text}}</strong>
        </div>
    </card>
    <span ref.name="alert">
        <alert alertType.bind="@alert.type()" message.bind="@alert.text()"></alert>
    </span>
    <!--
    <span if.bind="!@showOnly">
        <list-passenger bookingId="@booking.id"></list-passenger>
    </span>
    -->
</div>

<script>

    function initState(props) {
    	//debugger;
    	return {
    		booking: props.booking,
            bookingUtils: (new Utils()).bookings,
            status: (new Utils()).bookings.status(props.booking),
            showOnly: props.showOnly,
            alert: new Alert(null, $patchChanges, "alert"),
        }
    }


    function onPropertyChange(props){
    	//debugger;
    	if(props.booking) {
    		this.state.booking = props.booking.newValue;
		    this.state.status = (new Utils()).bookings.status(props.booking.newValue);
	    }
    	if(props.showOnly) this.state.showOnly = props.showOnly.newValue;
    }


    function onClick(){
    	//debugger;
    	this.emitEvent('click', this.state.booking);
    }

    function calculatePaymentDetail() {
    	//debugger;
    	var booking = this.state.booking;
    	var self = this;
    	if(!booking.uniqueCode) {
		    booking.uniqueCode = Math.floor(Math.random() * 1000);
		    booking.totalPrice = booking.costLandArrangements + booking.costTickets + booking.uniqueCode;
            booking.waitingForPaymentUntil = (new Date().addHours(3)).getTime();
		    dpd.bookings.put(booking, function (bkg, err) {
		    	//debugger;
			    self.state.alert.alert(err);
			    if(!err) {
				    window.location.hash = '#app/booking.paymentDetails:bookingId=' + booking.id;
			    }
		    });
	    } else {
		    window.location.hash = '#app/booking.paymentDetails:bookingId=' + booking.id;
        }
    }

    function onEditPassenger() {
    	window.location.hash="#app/passenger.home:bookingId=" + this.state.booking.id;
    }

    function onSaveBooking() {
    	this.emitEvent('saved');
    }

    function onCancelBooking() {
    	//debugger;
    	var self = this;
	    return new Promise(function (resolve) {
	    	//debugger;
        	if(self.state.status.code == 0) {
			    dpd.bookings.del(self.state.booking.id, function (err) {
			    	//debugger;
				    self.state.alert.alert(null);
                    self.emitEvent("cancelled");
				    resolve(null);
			    });
		    } else {
        		self.state.booking.isCancelled = true;
		        dpd.bookings.put(self.state.booking.id, self.state.booking, function (res, err) {
			        self.state.alert.alert(err);
			        if(!err) {
				        self.emitEvent("cancelled");
			        }
			        resolve(null);
		        });
            }
	    });
    }

</script>