<inject from="/component/panel" name="card"></inject>
<inject from="/component/alert" name="alert"></inject>
<inject from="/component/entry" name="entry"></inject>

<div>
    <card click.trigger="onClick()" title.bind="@booking.package.packageName">
        <div slot.name="body">
            <strong>Booking No: {{@booking.bookingNo}}</strong><br/>
            Travel Date: {{(@booking.package.travelDateFrom).toStringDateRange(@booking.package.travelDateUntil)}}<br/>
            Operator: {{@booking.travelAgent.travelAgentName}}<br/>
            Land Arrangements: {{@booking.costLandArrangements ? @booking.costLandArrangements.toFormattedString() : ''}}<br/>
            Tickets: {{@booking.costTickets ? @booking.costTickets.toFormattedString() : ''}}<br/>
            Total passenger: {{@booking.numberOfPassengers ? @booking.numberOfPassengers : ''}}<br/>
            Total Price: {{(@booking.totalPrice ? @booking.totalPrice.toFormattedString() : '')}}<br/>
            Unique Code: {{@booking.uniqueCode ? @booking.uniqueCode : ''}}<br/>
            Grand Total: {{(@booking.totalPrice + @booking.uniqueCode) ? (@booking.totalPrice + @booking.uniqueCode).toFormattedString() : ''}}<br/>
            Expiry Date: {{(@booking.waitingForPaymentUntil ? @booking.waitingForPaymentUntil.toDateComponents(false, true) : '')}}<br/>
            <div if.bind="!@showOnly">
                <div class="row">
                    <entry type="button" name="btnSave" value="Save & Close" click.trigger="onSaveBooking()"></entry>
                    <entry type="button" name="btnCancel" if.bind="@flow.isTransitionAllowed(@booking.bookingStatus, 'CCL')" value="Cancel Booking" click.trigger="onCancelBooking()"></entry>
                    <entry type="button" name="btnPassengers" value="Passengers..." click.trigger="onEditPassenger()"></entry>
                    <entry type="button" name="btnPaymentDetail" if.bind="@booking.numberOfPassengers > 0" value.bind="(@booking.bookingStatus =='DPS' ? 'Next Step: ' : '') + 'Payment Detail'" click.trigger="calculatePaymentDetail()"></entry>
                </div>
            </div>
        </div>
        <div slot.name="footer">
            <strong>Status: {{@flow.status(@booking.bookingStatus)}}</strong>
        </div>
    </card>
    <span ref.name="alert">
        <alert alertType.bind="@alert.type()" message.bind="@alert.text()"></alert>
    </span>
    <!--
    <span if.bind="!@showOnly">
        <list-passenger bookingId="@booking.id"></list-passenger>
    </span>
    -->
</div>

<script>

    function initState(props) {
    	debugger;
    	return {
    		booking: props.booking,
            flow: (new Utils()).flow.booking,
            showOnly: props.showOnly,
            alert: new Alert(null, $patchChanges, "alert"),
        }
    }


    function onPropertyChange(props){
    	//debugger;
    	if(props.booking) {
    		this.state.booking = props.booking.newValue;
		    this.state.status = (new Utils()).bookings.status(props.booking.newValue);
	    }
    	if(props.showOnly) this.state.showOnly = props.showOnly.newValue;
    }


    function onClick(){
    	//debugger;
    	this.emitEvent('click', this.state.booking);
    }

    function calculatePaymentDetail() {
    	debugger;
    	var booking = this.state.booking;
    	var self = this;
    	if(!booking.uniqueCode) {
		    booking.uniqueCode = Math.floor(Math.random() * 1000);
		    booking.totalPrice = booking.costLandArrangements + booking.costTickets + booking.uniqueCode;
            booking.waitingForPaymentUntil = (new Date().addHours(3)).getTime();
            booking.bookingStatus = 'WFP';
		    dpd.bookings.put(booking, function (bkg, err) {
		    	//debugger;
			    self.state.alert.alert(err);
			    if(!err) {
				    window.location.hash = '#app/booking.paymentDetails:bookingId=' + booking.id;
			    }
		    });
	    } else {
		    window.location.hash = '#app/booking.paymentDetails:bookingId=' + booking.id;
        }
    }

    function onEditPassenger() {
    	window.location.hash="#app/passenger.home:bookingId=" + this.state.booking.id;
    }

    function onSaveBooking() {
    	this.emitEvent('saved');
    }

    function onCancelBooking() {
    	//debugger;
    	var self = this;
	    return new Promise(function (resolve) {
	    	//debugger;
        	if(self.state.booking.bookingStatus == 'DPS') {
			    dpd.bookings.del(self.state.booking.id, function (err) {
			    	debugger;
				    self.state.alert.alert(null);
                    self.emitEvent("cancelled");
				    resolve(null);
			    });
		    } else {
		        self.state.booking.isCancelled = true;
		        self.state.booking.bookingStatus = 'CCL';
		        dpd.bookings.put(self.state.booking.id, self.state.booking, function (res, err) {
			        debugger;
		        	self.state.alert.alert(err);
			        if(!err) {
				        self.emitEvent("cancelled");
			        }
			        resolve(null);
		        });
            }
	    });
    }

</script>