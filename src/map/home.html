<inject from="/component/panel" name="panel"></inject>
<inject from="/component/home-button" name="home"></inject>
<inject from="/component/alert" name="alert"></inject>

<div>
    <panel title='Map'>
        <div slot.name='body'>
            <span ref.name="alert">
                <alert alertType.bind="@alert.type()" message.bind="@alert.text()"></alert>
            </span>
            <div name = 'map' style='width:100%;height:500px'>

            </div>
        </div>
        <div slot.name="footer">
            <div class="row">
                <home></home>
            </div>
        </div>
    </panel>
</div>

<script>
    function initState(props){
    	var state = {
		    alert: new Alert(null, $patchChanges, "alert"),
            infoText:'',
        }
	    if((typeof google) == 'undefined') {
    		state.alert.alert('Google Map is not available at the moment');
	    }
	    else {
		    console.log(0);

		    google.maps.event.addDomListener(window, 'load', initMap);
	    }

        return state;
    }
	var marker = null;
	var circle = null;

	function initMap() {
		console.log(1);
		geo.getLocation().then(function(loc) {
			console.log(2);
			if(!loc.err) {
				console.log(3);
				var map = new google.maps.Map(document.getElementsByName('map')[0], {
					zoom: 17,
					center: loc,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				});

				marker = new google.maps.Marker({
					position: loc,
					map: map,
					animation: google.maps.Animation.DROP,
				});

				circle = new google.maps.Circle({
					center: loc,
					radius: loc.acc,
					map: map,
					fillColor: '#0000ff',
					fillOpacity: 0.3,
					strokeColor: '#0000ff',
					strokeOpacity: 0.0,
				});

				geo.watchLocation(onSuccess, onError);
			}
			else {
				console.log(4);
				alert(loc.msg);
            }
		});
	}

	function onSuccess(pos, accuracy) {
		marker.setPosition(pos);
		circle.setCenter(pos);
		circle.setRadius(accuracy);
	}

	// onError Callback receives a PositionError object
	//
	function onError(error) {
		debugger;
		this._state.alert.alert(error);
	}

</script>
