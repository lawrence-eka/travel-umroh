<inject from="/component/panel" name="panel"></inject>
<inject from="/component/home-button" name="home"></inject>
<inject from="/component/alert" name="alert"></inject>

<div>
    <panel title='Map'>
        <div slot.name='body' name = 'map' style='width:100%;height:500px'>
        </div>
        <div slot.name="footer">
            <div class="row">
                <home></home>
            </div>
        </div>
    </panel>
</div>

<script>
    function initState(props){
    	var state = {
		    alert: new Alert(null, $patchChanges, "alert"),
            infoText:'',
        }
	    if((typeof google) == 'undefined') {
    		state.alert.alert('Google Map is not available at the moment');
	    }
	    else {
		    google.maps.event.addDomListener(window, 'load', initMap);
	    }

        return state;
    }
	var marker = null;
	var circle = null;

	function initMap() {
		debugger;
		geo.getLocation().then(function(loc) {
			if(!loc.err) {
				var map = new google.maps.Map(document.getElementsByName('map')[0], {
					zoom: 17,
					center: loc,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				});

				marker = new google.maps.Marker({
					position: loc,
					map: map,
					animation: google.maps.Animation.DROP,
				});

				circle = new google.maps.Circle({
					center: loc,
					radius: loc.acc,
					map: map,
					fillColor: '#0000ff',
					fillOpacity: 0.3,
					strokeColor: '#0000ff',
					strokeOpacity: 0.0,
				});

				geo.watchLocation(onSuccess, onError);
			}
			else {
				alert(loc.msg);
            }
		});
	}

	function onSuccess(pos, accuracy) {
		marker.setPosition(pos);
		circle.setCenter(pos);
		circle.setRadius(accuracy);
	}

	// onError Callback receives a PositionError object
	//
	function onError(error) {
		debugger;
		this._state.alert.alert(error);
	}

</script>
